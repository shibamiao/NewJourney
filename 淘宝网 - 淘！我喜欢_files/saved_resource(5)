/*! umpp 2013-11-29 */
KISSY.add("tbc/umpp/1.4.4/mods/messenger",function(a){function b(a,b){return s.push([a,b])-1}function c(a){return s[a]=null}function d(b,c,d){var e={type:b,content:c},f=d;if(a.isString(d)?(f=l.get("#"+d),d=f.contentWindow):d.contentWindow&&(d=d.contentWindow),h())try{return d.KISSY.TBC.Messenger.fire(b,c)}catch(j){}n?i&&(i.callSWF?i.callSWF("send",[e,g(f)]):i.send(e,g(f))):d.postMessage(m.stringify(e),"*")}function e(b,c){a.each(s,function(a){a&&a[0]===b&&a[1](c)})}function f(b,c){var d,e=(n?"parentFlash="+t+"&childFlash=_MessengerChildFlash_"+a.now()+"&":"")+"domain="+document.domain;a.isString(b)?(d=b,b={}):d=b.src,b.src=d+(d.indexOf("?")>-1?"&":"?")+e;var f=l.create("<iframe>",b);return f.setAttribute("width",1),f.setAttribute("height",1),l.get(c||"body").appendChild(f)}function g(a){var b=a.src,c=/childFlash=([^&]+)/;if(b){var d=b.match(c);if(d&&d[1])return d[1];throw"iframe has no flashName param"}}function h(){return!!document.domain.match(/^taobao\.(com|net)/)}var i,j=window,k=a.namespace("TBC.Messenger"),l=a.DOM,m=(a.Event,a.UA,a.JSON),n=(document.domain,"undefined"==typeof postMessage||!j.addEventListener),o=-1===location.host.indexOf("daily")&&-1===location.host.indexOf("net"),p="http://"+(o?"g.tbcdn.cn":"g.assets.daily.taobao.net"),q="1.4.4",r=parseFloat(q)?p+"/tbc/umpp/"+q+"/flash-post-message.swf":"flash-post-message.swf",s=[],t="_MessengerFlash_"+a.now();return(!h()||n)&&(n?(a.version>1.3&&a.config({modules:{flash:{alias:["gallery/flash/1.0/"]}}}),a.use(parseFloat(a.version,10)>1.2?"swf":"flash",function(a,b){window._Messenger_Flash_PostMessage=function(a,b){var c=b.type,d=b.msg;"message"==c&&d&&e(d.type,d.content)};var c={src:r,attrs:{width:1,height:1,style:"position:absolute;top:0"},params:{flashVars:{jsentry:"_Messenger_Flash_PostMessage",swfid:"J_MessengerFlashPostMessage",name:t},allowscriptaccess:"always"}};b&&parseFloat(a.version,10)>1.2?i=new b(c):a.Flash&&a.Flash.add&&a.Flash.add("#J_FlashPostMessageContainer",c,function(a){i=a.swf})})):j.addEventListener("message",function(b){var c=b.data;if(c&&a.isString(c))try{var d=m.parse(c);e(d.type,d.content)}catch(f){}},!1)),a.mix(k,{register:b,unregister:c,send:d,createIframe:f,fire:e,flashName:t})},{requires:["core"]}),KISSY.add("tbc/umpp/1.4.4/mods/getNick",function(a){var b=a.namespace("TBC.umpp");return b.getNick=function(b){var c=a.Cookie.get("tracknick")||a.Cookie.get("lgc");return b?encodeURIComponent(unescape(c).replace(/\\u/g,"%u")):c}},{requires:["cookie"]}),KISSY.add("tbc/umpp/1.4.4/mods/trinity",function(a){function b(a,b,c){this.nick=a||"umpp-guest",this.swfurl=b,this.evs=c,this._init()}var c=a.DOM,d=(a.JSON,a.namespace("TBC.umpp")),e="UM_",f=window,g="J_UmppUserContainer",h="_umpp_trinity_",i=b.prototype;return i._init=function(){var b=this,d={src:b.swfurl,attrs:{width:1,height:1},params:{flashVars:{jsentry:h,swfid:e+b.nick+a.now(),group:b.nick},allowscriptaccess:"always"}};f[h]=function(a,c){var d=c.type,e=c.data,f=b.evs,g=f[d];g&&g.call(b,"message"===d?e:null)},a.use(parseFloat(a.version,10)>1.2?"swf":"flash",function(a,e){e&&parseFloat(a.version,10)>1.2?b.swf=new e(d):a.Flash&&a.Flash.add&&(c.get("#"+g)||document.body.appendChild(c.create('<div id="'+g+'" style="height:1px;width:1px;overflow:hidden;position:absolute;bottom:1px"></div>')),a.Flash.add("#"+g,d,function(a){b.swf=a.swf}))})},i.fire=function(a,b){return this.swf.callSWF?this.swf.callSWF("fire",[a,b]):(this.swf.fire(a,b),void 0)},i.destroy=function(){var a=this;try{a.swf.destroy?a.swf.destroy():c.remove("#"+g),delete f[h]}catch(b){}},d.Trinity=b},{requires:["dom","json"]}),KISSY.add("tbc/umpp/1.4.4/mods/initGuest",function(a){function b(b,f,g){return e._guestTimer=setTimeout(function(){a.getScript(parseFloat(c)?f+"/tbc/umpp/"+c+"/guest-min.js":"guest.js",function(){parseFloat(a.version,10)>1.1&&a.use(parseFloat(c)?"tbc/umpp/"+c+"/guest":"tbc/umpp/guest")})},d),a.mix(e,{isOnline:b,cdnPath:f,Trinity:g}),e}var c="1.4.4",d=18e4,e=a.namespace("TBC.umpp");return a.mix(e,{register:function(){},send:function(){},destroy:function(){this.trinity&&(this.trinity.destroy(),delete this.trinity),this._guestTimer&&(clearTimeout(this._guestTimer),this._guestTimer=null)}}),e.initGuest=b}),KISSY.add("tbc/umpp/1.4.4/mods/initUser",function(a){function b(a){m.get("#"+o)||n.createIframe({src:a,id:o,frameborder:0,scrolling:"no"})}function c(b){a.isArray(b)&&b.length&&a.each(b,function(a){"1063"==a.t1&&s.trinity.fire({content:[a],identity:[s.nick,a.t1,"1"].join("-")})})}function d(){n.register("umppready",function(){k=!0,f("master"),f("join")}),n.register("umppdata",function(a){s.notify(a,!0),c(a)})}function e(b,c){if(!c)return!1;var d=c.body,e=d.content;if(a.isObject(d))if("-"===d.identity)a.each(e,function(b){a.each(s._Events,function(a){a&&b.t1==a[0]&&a[1](b)})});else if(p===d.type)if(i){var g=e[0],h=e[1];"umpp-store-get"===g?s.getItem(h,function(a){b.fire.call(b,{type:p,content:[h,a]},c.from)}):"umpp-store-remove"===g?s.removeItem.call(s,h):"umpp-store-set"===g&&s.setItem.apply(s,h)}else{var e=d.content;n.fire("umpp-store-get-"+e[0],e[1])}else if(q===d.type){if(!d.includeSelf&&c.from===c.to)return!1;f("message",d.content)}}function f(b,c){a.each(s._SwfEvents,function(a){a&&b===a[0]&&(a[1](c),"message"!==b&&(a[0]=b+"_ed"))})}function g(a,c,g,h){s.trinity=new a(c,g,{master:function(){i=!0,d(),b(h),k&&f("master")},join:function(){j=!0,(i&&k||!i)&&f("join")},message:function(a){e(this,a)}})}function h(a,b,c,d){var e="http://mpp."+(a?"taobao.com":"daily.taobao.net:8080")+"/ajaxconn2.html?appId="+r,f=parseFloat(l)?b+"/tbc/umpp/1.4.2/trinity.swf":"trinity.swf";return s.nick=c,g(d,c,f,e),s}var i,j,k,l="1.4.4",m=a.DOM,n=a.TBC.Messenger,o="J_Um_Iframe",p="_trinity_notify_private",q="_trinity_notify_public",r=-1===location.host.indexOf("metting.wangwang")?1064:1065,s=a.namespace("TBC.umpp");return a.mix(s,{_Events:[],_SwfEvents:[],_StoreCache:{},_storeData:function(a,b){i&&(this._StoreCache[a]=b)},_removeData:function(a){i&&this._StoreCache[a]&&delete this._StoreCache[a]},on:function(a,b){return(i&&k||!i&&j)&&("master"===a&&i||"join"===a&&j)?(b(),!0):this._SwfEvents.push([a,b])-1},off:function(b){return a.isNumber(b)?this._SwfEvents[b]=null:void 0},register:function(a,b,c){var d=this,e=function(e,f){b(e,f),c?d._storeData(a,e):d.removeItem(a)};return d.getItem(a,function(a){a&&e(a,!0)}),d._Events.push([a,e])-1},unregister:function(a){return this._Events[a]=null},send:function(a,b){return i?n.send.call(null,a,b,o):(this.trinity&&this.trinity.fire({type:p,content:[a,b]},"_"+this.nick),void 0)},notify:function(a,b){return this.trinity.fire({type:q,content:a,includeSelf:b,identity:"-"})},setItem:function(a,b){var c=this;c.on("join",function(){c._storeData(a,b),c.send("umpp-store-set",[a,b])})},getItem:function(a,b){var c=this,d=this._StoreCache[a];i&&d?b(d):c.on("join",function(){var d=n.register("umpp-store-get-"+a,function(e){n.unregister(d),c._storeData(a,e),b(e)});c.send("umpp-store-get",a)})},removeItem:function(a){var b=this;b.on("join",function(){b._removeData(a),b.send("umpp-store-remove",a)})},clear:function(a){return this.send("clearTMsg",a)},destroy:function(){this.trinity&&(this.trinity.destroy(),delete this.trinity),m.remove("#"+o),i=void 0,j=void 0,k=void 0,this._StoreCache={}}}),s.initUser=h},{requires:["core"]}),KISSY.add("tbc/umpp/1.4.4/index",function(a){function b(){var b,d=a.Cookie,e=-1===location.host.indexOf("daily"),f=d.get("_l_g_")||d.get("lgc"),g="http://g."+(e?"tbcdn.cn":"assets.daily.taobao.net"),h=c._Events,i=c._SwfEvents;return b=f?c.initUser(e,g,c.getNick(!0),c.Trinity):c.initGuest(e,g,c.Trinity),h&&a.mix(b,{_Events:h}),i&&a.mix(b,{_SwfEvents:i}),a.mix(c,b)}a.version>=1.4&&a.config({modules:{ajax:{alias:["io"]},flash:{alias:["gallery/flash/1.0/"]}}});var c=a.namespace("TBC.umpp");return c.init=b,b()},{requires:["core","tbc/umpp/1.4.4/mods/messenger","tbc/umpp/1.4.4/mods/getNick","tbc/umpp/1.4.4/mods/trinity","tbc/umpp/1.4.4/mods/initGuest","tbc/umpp/1.4.4/mods/initUser"]});